<div class="container">
    <h1><i class="fas fa-receipt"></i> Receipts</h1>
    <div class="full-line"></div>
    <% if (purchases && purchases.length > 0) { %>
      <h2 class="text-2xl font-bold text-center text-gray-700 my-8"><i class="fas fa-list"></i> Purchase Summary</h2>

      <div class="overflow-x-auto shadow-md sm:rounded-lg">
        <table class="w-full text-sm text-left text-gray-500">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3"><i class="fas fa-pills"></i> Medicine</th>
              <th scope="col" class="px-6 py-3 text-center"><i class="fas fa-hashtag"></i> Tablets Bought</th>
              <th scope="col" class="px-6 py-3 text-center"><i class="fas fa-rupee-sign"></i> Price per Tablet</th>
              <th scope="col" class="px-6 py-3 text-center"><i class="fas fa-calculator"></i> Total</th>
            </tr>
          </thead>
          <tbody>
            <% purchases.forEach((purchase, index) => { %>
              <tr class="bg-white border-b hover:bg-gray-50">
                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap"><%= purchase.medicine %></td>
                <td class="px-6 py-4 text-center"><%= purchase.quantity %></td>
                <td class="px-6 py-4 text-center">₹<%= purchase.pricePerTablet.toFixed(2) %></td>
                <td class="px-6 py-4 text-center font-semibold">₹<%= purchase.total.toFixed(2) %></td>
              </tr>
            <% }); %>
            <tr class="bg-gray-100 font-semibold text-gray-900">
              <td colspan="3" class="px-6 py-4 text-right">Subtotal:</td>
              <td class="px-6 py-4 text-center">₹<%= grandTotal.toFixed(2) %></td>
            </tr>
            <% if (discountPercent > 0) { %>
            <tr class="bg-gray-100 font-semibold text-gray-900">
              <td colspan="3" class="px-6 py-4 text-right">Discount (<%= discountPercent %>%):</td>
              <td class="px-6 py-4 text-center">-₹<%= discountAmount.toFixed(2) %></td>
            </tr>
            <% } %>
            <tr class="bg-gray-200 font-bold text-gray-900 text-base">
              <td colspan="3" class="px-6 py-4 text-right">Total Amount:</td>
              <td class="px-6 py-4 text-center">₹<%= discountedTotal.toFixed(2) %></td>
            </tr>
          </tbody>
        </table>
      </div>



      <form action="/generate-receipts" method="POST" class="text-center my-8">
        <input type="hidden" name="action" value="">
        <label for="patientName" class="font-bold"><i class="fas fa-user"></i> Customer Name:</label>
        <input type="text" name="patientName" id="patientName" placeholder="Enter customer name (optional)" value="<%= patientName || '' %>" class="mt-2 px-4 py-2 border rounded-md">
        <br>
        <div class="text-center my-4">
          <button type="button" id="confirm-purchase-btn" onclick="confirmPurchase()" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 font-semibold <%= confirmed ? 'opacity-50 cursor-not-allowed' : '' %>" <%= confirmed ? 'disabled' : '' %>>
            <i class="fas fa-check-circle"></i> Confirm Purchase
          </button>
          <div id="confirmMessage" class="mt-2 text-green-600 font-semibold hidden">Purchase confirmed</div>
        </div>

        <button type="submit" id="generate-bill-btn" onclick="document.querySelector('input[name=\'action\']').value='generate'" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 <%= !confirmed ? 'opacity-50 cursor-not-allowed' : '' %>" <%= !confirmed ? 'disabled' : '' %>><i class="fas fa-check"></i> Generate Bill</button>
      </form>

      <% if (generated) { %>
        <div class="text-center mt-4">
          <p class="text-green-600 font-semibold">Report generated</p>
        </div>

        <div class="text-center mt-4">
          <button onclick="printReceipt()" class="text-blue-600 hover:underline mr-4">
            <i class="fas fa-print"></i> Print Report
          </button>
        </div>
      <% } %>

      <script>
        async function confirmPurchase() {
            const confirmBtn = document.getElementById('confirm-purchase-btn');
            const billBtn = document.getElementById('generate-bill-btn');
            const patientName = document.getElementById('patientName').value;
            const confirmMsg = document.getElementById('confirmMessage');

            confirmBtn.disabled = true;
            confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const response = await fetch('/generate-receipts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ action: 'confirm', patientName: patientName })
                });

                const result = await response.json();

                if (result.success) {
                    confirmMsg.classList.remove('hidden');
                    billBtn.disabled = false;
                    billBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    alert('Error confirming purchase: ' + result.message);
                    confirmBtn.disabled = false; // Re-enable on failure
                    confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } catch (error) {
                console.error('Error confirming purchase:', error);
                alert('An error occurred. Please try again.');
                confirmBtn.disabled = false; // Re-enable on failure
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function printReceipt() {
          // Open the PDF in a new window and print it
          const printWindow = window.open('/download-pdf', '_blank');
          setTimeout(() => {
            printWindow.print();
          }, 1000); // Wait for PDF to load before printing
        }

        document.getElementById('confirmPurchaseBtn').addEventListener('click', function() {
          const purchases = <%- JSON.stringify(purchases) %>;
          const grandTotal = <%- grandTotal %>;
          const discountPercent = <%- discountPercent || 0 %>;
          const discountAmount = <%- discountAmount || 0 %>;
          const discountedTotal = <%- discountedTotal %>;

          fetch('/confirm-purchase', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              purchases: purchases,
              grandTotal: grandTotal,
              discountPercent: discountPercent,
              discountAmount: discountAmount,
              discountedTotal: discountedTotal
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              document.getElementById('confirmPurchaseBtn').disabled = true;
              document.getElementById('confirmPurchaseBtn').innerHTML = '<i class="fas fa-check-circle"></i> Purchase Confirmed';
              document.getElementById('generateReportBtn').disabled = false;
              alert('Purchase confirmed successfully!');
            } else {
              alert('Error confirming purchase: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error confirming purchase. Please try again.');
          });
        });
      </script>
    <% } %>
    <div class="text-center mt-8">
      <a href="/view-dashboard?clear=true" class="inline-block px-6 py-3 bg-green-600 text-white rounded-full font-semibold hover:bg-green-700 transition-colors">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
  </div>